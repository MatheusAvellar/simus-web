<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title> SimuS Web </title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body,main,section {
      box-sizing: border-box;
    }
    html, body {
      font-family: -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, Helvetica, Arial, sans-serif,
      "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      margin: 0;
      background-color: #efefef;
      width: 100%;
      height: 100%;
      min-width: 100%;
      min-height: 100%;
    }
    header {
      height: 20%;
      margin: 0 1em;
    }
    header > label {
      display: block;
      margin: 4px 0;
    }
    button {
      border-radius: 3px;
      border: 1px solid #1fa0e0;
      padding: 0.25em 0.5em;
      background-color: #d2ecf9;
      outline: 0;
    }
    button:focus {
      background-color: #a5d9f3;
    }
    button:active {
      background-color: #9bcfe9;
    }
    button[disabled] {
      background-color: #e7e7e7;
      border-color: #898989;
    }
    input,output {
      width: calc(100% - 5.5em);
      max-width: 600px;
      padding: 0.5em 1em;
      border-radius: 3px;
      display: inline-block;
      vertical-align: middle;
      font-family: "Roboto Mono", monospace;
      font-size: inherit;
      border: 1px solid;
      box-sizing: border-box;
    }
    input {
      border-color: #aeaeae;
    }
    output {
      border-color: #aeaeae;
      background-color: #282828;
      color: #eee;
      cursor: text;
    }
    label > span {
      display: inline-block;
      width: 3.5em;
      margin-right: .2em;
      text-align: right;
      color: #aeaeae;
    }
    main {
      height: 80%;
      display: grid;
      grid-template-columns: 1fr auto;
    }
    section.header {
      box-sizing: border-box;
      height: 3vh;
      align-self: center;
      vertical-align: middle;
      line-height: 3vh;
      padding: 0 48px;
      color: #aeaeae;
      z-index: 2;
    }
    section[id$="wrapper"] {
      box-sizing: border-box;
      height: 77vh;
      font-family: "Roboto Mono", monospace;
    }
    #code-editor {
      border-right-width: 0;
      border-bottom-width: 0;
    }
    #hex-wrapper {
      overflow-y: scroll;
      background-color: #fff;
      border: 1px solid #aeaeae;
      border-left-width: 0;
      border-bottom-width: 0;
      font-size: 85%;
    }
    #hex-wrapper > ol {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #hex-wrapper > ol > li {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      line-height: 1.7em;
      border-bottom: 1px solid #aeaeae;
    }
    #hex-wrapper > ol > li:hover {
      background-color: #e0e0ff;
    }
    #hex-wrapper > ol > li > .label {
      background-color: #858585;
      padding: .2em;
      color: #fff;
      user-select: none;
      -moz-user-select: none;
      cursor: default;
      width: 48px;
      text-align: center;
      box-sizing: border-box;
    }
    #hex-wrapper > ol > li > .byte {
      margin: 0 .3em;
      font-weight: 300;
      color: #b0b0b0;
    }
    #hex-wrapper > ol > li > .byte.changed {
      font-weight: 400;
      color: #010101;
    }
    nav#tabs ul {
      margin: 0;
      padding: 0;
      list-style: none;
      user-select: none;
    }
    nav#tabs ul li {
      display: inline-block;
      padding: 0 .5em;
      cursor: default;
      border: 1px solid transparent;
    }
    nav#tabs ul li.selected {
      background-color: #fff;
      border-color: #aeaeae;
      border-bottom: 1px solid #fff;
      color: #444;
    }

    @media screen and (max-width: 1000px) {
      main {
        grid-template-columns: 1fr;
      }
      section.header:nth-of-type(2){
        display: none;
      }
      #hex-wrapper > ol > li > .byte:last-of-type {
        margin-right: 48px;
      }
    }
    @media screen and (max-width: 700px) {
      #hex-wrapper > ol > li > .byte:last-of-type {
        margin-right: .3em;
      }
    }
  </style>
  <style data-for="highlights">
    #code-wrapper {
      position: relative;
    }
    #code-editor {
      margin: 0;
      border-radius: 0;
      -webkit-text-fill-color: transparent;
      background-color: transparent;
      position: relative;
      z-index: 1;
      tab-size: 2;
      -o-tab-size: 2;
      -moz-tab-size: 2;
    }
    #backdrop {
      width: calc(100% - 48px);
      height: 100%;
      margin-left: 48px;
      box-sizing: border-box;
      position: absolute;
      z-index: 0;
      overflow: hidden;
      pointer-events: none;
      background-color: #fff;
    }
    #highlights {
      position: absolute;
      font-family: "Roboto Mono",monospace;
      border: 1px solid transparent;
      overflow-wrap: normal;
      overflow-x: auto;
      white-space: pre;
      box-sizing: border-box;
      line-height: 1.5;
      color: #3b3b3b;
      padding: 10px 10px 25px;
      height: 100%;
      width: 100%;
      tab-size: 2;
      -o-tab-size: 2;
      -moz-tab-size: 2;
    }
    #highlights.hidden {
      display: none;
    }
    mark {
      border-radius: 3px;
      background-color: transparent;
    }
    .highlight-number {
      color: #9f31d2;
    }
    .highlight-string {
      color: #3e751e;
    }
    .highlight-operation {
      color: #0070a5;
    }
    .highlight-keyword {
      color: #bd3e3e;
    }
    .highlight-label {
      color: #04716f;
    }
    .highlight-comment {
      color: #6b6b6b;
    }
  </style>
</head>
<body onload="init();">
  <header>
    <nav>
      <button id="compile-btn"> Compile </button>
      <button disabled> Run </button>
      <button disabled> Step </button>
    </nav>
    <label>
      <span>Input:</span>
      <input placeholder="SIMUS" type="text"/>
    </label>
    <label>
      <span>Output:</span>
      <output>SIMUS</output>
    </label>
  </header>
  <main>
    <section class="header">
      <nav id="tabs">
        <ul>
          <li class="selected">Code</li>
          <li style="opacity:.5;font-style:italic">Compilation</li>
          <li style="opacity:.5;font-style:italic">Debugging</li>
        </ul>
      </nav>
    </section>
    <section class="header">Memory</section>
    <section id="code-wrapper">
      <div id="backdrop">
        <div id="highlights"></div>
      </div>
      <textarea id="code-editor" spellcheck="false"></textarea>
    </section>
    <section id="hex-wrapper"></section>
  </main>
  <script>
    const code_editor = document.getElementById("code-editor");
    const highlights = document.getElementById("highlights");
    const backdrop = document.getElementById("backdrop");
    let sim;

    function init() {
      toggleSyntaxHighlighting(true);

      // Generate memory viewer
      generateMemView();

      // <textarea> line numbers (by myself :D) via:
      // https://github.com/MatheusAvellar/textarea-line-numbers
      TLN.append_line_numbers("code-editor");

      // Hook tab swapping events
      const tablist = document.getElementById("tabs").firstElementChild.children;
      // For each tab in the list
      for(let tab of tablist) {
        // Hook a "click" event
        tab.addEventListener("click", function() {
          // Get index of current tab (0, 1, ...)
          /// let index = 0;
          /// for(let node = tab; node = node.previousElementSibling; index++);
          // Hide all screens
          /// TODO
          // Show current screen based on selected tab
          /// TODO

          // Remove the "selected" class from other tabs
          for(let li of tablist)
            li.classList.remove("selected");
          // And add it to itself
          tab.classList.add("selected");
        });
      }

      // Create SimuS instance
      sim = new SimuS();

      document.getElementById("compile-btn").addEventListener("click", function() {
        const res = sim.compile(code_editor.value);
        if(res === -1) console.warn("Compilation error");
        else console.warn("Compiled successfully");
      });
    }

    // Syntax Highlighting on <textarea> trick via:
    // https://codersblock.com/blog/highlight-text-inside-a-textarea/
    let syntaxHighlightingAlreadyOn = false;
    function toggleSyntaxHighlighting(turnOn) {
      // Ensure values are boolean
      turnOn = !!turnOn;
      syntaxHighlightingAlreadyOn = !!syntaxHighlightingAlreadyOn;

      // Event names and handlers
      const eventHooks = [
        { name: "input", fun: handleInput },
        { name: "input", fun: handleScroll },
        { name: "scroll", fun: handleScroll },
        { name: "mousewheel", fun: handleScroll },
      ];

      // If requested to turn on, and is already on
      if(turnOn && syntaxHighlightingAlreadyOn)
        // Leave
        return;

      // Show / Hide highlights
      if(turnOn)
        highlights.classList.remove("hidden");
      else
        highlights.classList.add("hidden");

      // Hook / Unhook each event from the array
      for(let event of eventHooks) {
        // If requested to turn on, then hook events
        if(turnOn)
          code_editor.addEventListener(event.name, event.fun);
        // Otherwise, unhook them
        else
          code_editor.removeEventListener(event.name, event.fun);
      }

      // Trigger input event to update highlighting
      code_editor.dispatchEvent(new Event("input", {
        "bubbles": true, "cancelable": true
      }));

      // Update syntax highlighting tracking variable
      syntaxHighlightingAlreadyOn = turnOn;
    }
    function handleInput() {
      const text = code_editor.value;
      highlights.innerHTML = applyHighlights(text);
    }
    function applyHighlights(text) {
      const operationsRegEx = /\b(NOP|STA|STS|LDA|LDS|ADD|ADC|SUB|SBC|OR|XOR|AND|NOT|SHL|SHR|SRA|JMP|JN|JP|JZ|JNZ|JC|JNC|IN|OUT|JSR|RET|PUSH|POP|TRAP|HLT)\b/g;
      const keywordRegEx = /\b(ORG|END|DS|DB|DW|STR|EQU)\b/g;
      const labelRegEx = /[A-Z_]+:/gm;
      const decimalNumbersRegEx = /[@#]?[0-9]+[HB]?/g;
      const stringsRegEx = /\"[ !#-~]*\"/g;
      const commentsRegEx = /(;.*)/;

      let out = "";
      const lines = text.split("\n");

      for(let i = 0; i < lines.length; i++) {
        const arr = lines[i].split(commentsRegEx);
        // FIXME: Numbers inside a string are getting recognized as numbers
        // and not as part of the string; i.e. STR ["string [3] string"]
        out += xss(arr[0])
          .replace(stringsRegEx, `<mark class="highlight-string">$&</mark>`)
          .replace(decimalNumbersRegEx, `<mark class="highlight-number">$&</mark>`)
          .replace(operationsRegEx, `<mark class="highlight-operation">$&</mark>`)
          .replace(keywordRegEx, `<mark class="highlight-keyword">$&</mark>`)
          .replace(labelRegEx, `<mark class="highlight-label">$&</mark>`);

        if(arr.length > 1 && arr[1].length) {
          out += `<mark class="highlight-comment">${xss(arr[1])}</mark>`;
        }
        out += "\n";
      }

      return out.replace(/\n$/g, "\n\n");
    }
    function xss(text) {
      return (text || "")
        .split("&").join("&amp;")
        .split(">").join("&gt;")
        .split("<").join("&lt;");
    }
    function handleScroll() {
      highlights.scrollTop = code_editor.scrollTop;
      highlights.scrollLeft = code_editor.scrollLeft;
    }

    async function sleep(ms) {
      return await new Promise(resolve => setTimeout(resolve, ms));
    }

    // Generate memory viewer
    async function generateMemView() {
      const hex_wrapper = document.getElementById("hex-wrapper");

      // e.g. 0x02 == from 0x0000 to 0x02FF
      //      0x7F == from 0x0000 to 0x7FFF
      // P.S. Yes, this sucks, I know
      const MEM_SIZE = 0x0F;

      // Generate all labels
      for(let i = 0; i <= MEM_SIZE; i++) {

        // Build a fragment to insert <li>'s
        const ol_fragment = document.createDocumentFragment();

        for(let j = i*0x100; j < 0xFF+i*0x100; j += 0x10) {
          // Create fragment for <li>
          const li_fragment = document.createDocumentFragment();

          const label = document.createElement("span");
          label.className = "label";
          label.textContent = j.toString(16).toUpperCase().padStart(4,"0");
          li_fragment.appendChild(label);

          for(let k = 0; k <= 0xF; k++) {
            const byte = document.createElement("span");
            byte.textContent = "00";
            byte.id = (j + k).toString(16).toUpperCase().padStart(4,"0");
            byte.className = "byte";
            li_fragment.appendChild(byte);
          }

          // Insert fragment into <li>
          const li = document.createElement("li");
          li.id = (j/16).toString(16).toUpperCase().padStart(2,"0")+"X";
          li.appendChild(li_fragment);

          // Insert <li> into <ol> fragment
          ol_fragment.appendChild(li);
        }

        // Insert fragment into <ol>
        const ol = document.createElement("ol");
        ol.id = i.toString(16).toUpperCase().padStart(2,"0").padEnd(4,"X");
        ol.appendChild(ol_fragment);

        // Insert <ol> into hex editor
        hex_wrapper.appendChild(ol);

        // Prevent blocking of main thread due to the
        // 65535+ (0xFFFF) new nodes being added
        // Perhaps I should lazy-load it?
        await sleep(75);
      }
    }

    // Insert sample code into editor
    code_editor.value = `ORG 0

INICIO:
; Faz a leitura do painel de chaves
     IN  0
     STA A
; Se a entrada for 0 termina o programa
     OR  #0
     JZ  FIM
; Testa se é par (bit 0=0)
     LDA A
     AND #1
     JNZ SENAO
; Se for, faz pares++
     LDA PARES
     ADD #1
     STA PARES
     JMP INICIO
SENAO:
; Incrementa I
     LDA IMPARES
     ADD #1
     STA IMPARES
     JMP INICIO
FIM: HLT

ORG 100
A:       DS 1
PARES:   DS 1
IMPARES: DS 1

END 0`;
  </script>
  <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:300,400&display=swap" rel="stylesheet"/>
  <link href="./tln.min.css" rel="stylesheet"/>
  <script src="./tln.min.js"></script>
  <script src="./simus.js"></script>

  <style data-for="tln">
    @media screen and (max-width: 400px) {
      body {
        font-size: 12px;
      }
      .tln-active, .tln-line, .tln-line::before {
        font-size: inherit;
      }
      .tln-active {
        width: calc(100% - 40px);
      }
      .tln-wrapper {
        width: 40px;
      }
      section.header {
        padding: 0 40px;
      }
      #backdrop {
        width: calc(100% - 40px);
        margin-left: 40px;
      }
    }
  </style>
</body>
</html>